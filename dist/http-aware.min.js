const COMBINABLE_HEADERS=new Set(["accept","accept-charset","accept-encoding","accept-language","cache-control","connection","content-encoding","expect","if-match","if-none-match","prefer","te","trailer","transfer-encoding","upgrade","via","warning","link"]);class RequestHeader extends HTMLFieldSetElement{static get observedAttributes(){return["header","value"]}get header(){return this.getAttribute("header")||""}get template(){return this.getAttribute("value")||""}get inputs(){return[...this.form.elements].filter(e=>e.getAttribute("for")===this.id||this.contains(e))}get values(){const e=new Set(this.inputs.map(e=>e.name));return Object.fromEntries([...new FormData(this.form,this.form._submitter)].filter(([t])=>e.has(t)))}interpolate(e,t){let r=e.replace(/\{\{/g,"\0O\0").replace(/\}\}/g,"\0C\0");return r=r.replace(/\{([a-zA-Z_][a-zA-Z0-9_-]*)(?:,([^}]+))?\}/g,(e,r,s)=>r in t?this.form.formatValue(t[r],s):e),r.replace(/\x00O\x00/g,"{").replace(/\x00C\x00/g,"}")}computeValue(){const e=this.interpolate(this.template,this.values);return e&&!/^[a-zA-Z_-]+=\s*$/.test(e)?e:""}}customElements.define("request-header",RequestHeader,{extends:"fieldset"});class HTTPAwareForm extends HTMLFormElement{static formatters={};formatValue(e,t){e=e??"";const r=t?.match(/^(\w+)(?:\(([^)]*)\))?$/);return HTTPAwareForm.formatters[r?.[1]]?.(e,...r?.[2]?.split(",").map(e=>e.trim())??[])??String(e)}preparedRequest=null;connectedCallback(){this.addEventListener("submit",this._handleNativeSubmit.bind(this))}_handleNativeSubmit(e){e._httpAware||(e.preventDefault(),e.stopPropagation(),this.requestSubmit(e.submitter))}getHeaderBoundFields(){return new Set([...this.querySelectorAll('fieldset[is="request-header"]')].flatMap(e=>e.inputs.flatMap(e=>e.name?[e.name]:[])))}collectHeaders(){const e=new Map;return this.querySelectorAll('fieldset[is="request-header"]').forEach(t=>{const r=t.header?.toLowerCase();r&&e.set(r,(COMBINABLE_HEADERS.has(r)&&e.get(r)||[]).concat(t.computeValue()))}),[...e].map(([e,t])=>[e,t.filter(e=>e||0===e).join(", ")])}collectFormData(){const e=new FormData(this,this._submitter);for(const t of this.getHeaderBoundFields())e.delete(t);return e}encodeBody(e,t){return"text/plain"===t?[...e].map(([e,t])=>`${e}=${t}`).join("\r\n"):"application/x-www-form-urlencoded"===t?new URLSearchParams([...e].filter(([,e])=>!(e instanceof File))):e}buildRequest(){const e=(this._submitter?.formMethod||this.getAttribute("method")||"GET").toUpperCase(),t=this.collectHeaders(),r=this.collectFormData(),s=new URL((this._submitter?.hasAttribute("formaction")?this._submitter.formAction:null)||this.action||location.href,location.origin);let a=null;return["GET","HEAD","DELETE"].includes(e)?s.search=new URLSearchParams([...r].map(([e,t])=>[e,t instanceof File?t.name:t])):a=this.encodeBody(r,this._submitter?.formEnctype||this.enctype||"application/x-www-form-urlencoded"),new Request(s.href,{method:e,headers:t,body:a,redirect:"follow"})}async navigateWithResponse(e,t,r="_self"){if(204===e.status&&console.warn("http-aware: 204 No Content for",t,e.url),!e.redirected&&(e.headers.get("content-type")||"").includes("text/html")){const t="_blank"===r?window.open("","_blank").document:document;t.open().write(await e.text()),t.close(),"_blank"!==r&&history.pushState(null,"",e.url)}else"_blank"===r?window.open(e.url):location.href=e.url}handleError(e){this.dispatchEvent(new CustomEvent("http-error",{bubbles:!0,detail:{error:e}})),console.error("http-aware error:",e)}submit(){const e=this.buildRequest(),t=this.target||"_self";fetch(e).then(r=>this.navigateWithResponse(r,e.method,t)).catch(e=>this.handleError(e))}requestSubmit(e=null){this._submitter=e;if(!(this.noValidate||e?.formNoValidate)&&!this.checkValidity())return void this.reportValidity();this.preparedRequest=this.buildRequest();const t=e?.formTarget||this.target||"_self",r=new SubmitEvent("submit",{submitter:e,bubbles:!0,cancelable:!0});if(r._httpAware=!0,this.dispatchEvent(r)){const e=this.preparedRequest.method;fetch(this.preparedRequest).then(r=>this.navigateWithResponse(r,e,t)).catch(e=>this.handleError(e))}this.preparedRequest=null}}customElements.define("http-aware",HTTPAwareForm,{extends:"form"}),"undefined"!=typeof module&&module.exports&&(module.exports={RequestHeader:RequestHeader,HTTPAwareForm:HTTPAwareForm});